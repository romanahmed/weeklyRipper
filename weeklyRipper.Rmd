---
title: "Data Science Talk"
author: "Roman Ahmed"
date: "5 July 2018"
output:
  # beamer_presentation: default
  ioslides_presentation:
    widescreen: yes
---


## Hello customers

**[Recruit Restaurant Visitor Forecasting:](https://www.kaggle.com/c/recruit-restaurant-visitor-forecasting)** Recruit Holdings has unique access to key data sets that could make automated future customer **prediction** possible. Specifically, Recruit Holdings owns *Hot Pepper Gourmet* (a restaurant review service), *AirREGI* (a restaurant point of sales service), and *Restaurant Board* (reservation log management software).

In this competition, you're challenged to use reservation and visitation data to **predict** the total number of visitors to a restaurant for future dates. This information will help restaurants be much more efficient and allow them to focus on creating an enjoyable dining experience for their customers.


**Objective:** You must use the reservations, visits, and other information from these sites to **forecast** future restaurant visitor totals on a given date. The training data covers the dates from 2016 until April 2017. The test set covers the last week of April and May of 2017. 



## Today's objective

* Building a solution to the problem
* Presenting findings to a combination of Technical and Business people (Manager Advanced Analytic, Data Scientists, Business Manager) for around 20-30 minutes covering
    + Brief Summary of the Problem
    + The step-by-step approach to how you came to the answer (including unsuccessful/poor performing models and how you improved them)
    + Your solution and its performance (against the  evaluation metric but also using other appropriate metrics that you deem necessary. Submit to Kaggle, if possible)
    + Limitations to your approach
    + How you could improve if given more time


## Standard modelling workflow

<!-- ![](images/modProcess.svg){height=80%} -->

```{r, out.height= "250px", echo = FALSE, fig.align='center'}
knitr::include_graphics("images/modProcess.svg")
```

Image/diagram credit: [topepo](https://github.com/topepo/rstudio-conf-2018/blob/master/Materials/images/intro-process-1.svg)

* Some popular EDA kernels shows various uni-variate (+ few bi-variate)
    + Either taking temporal or spatial dimension into account
* Two main strategies adopted for modelling in the kernel
    + Predictive modelling
    + Forecasting modelling
    
    
## Way to go forward

* Design a proof of concept that can be generalized
    + Solution will be based on time series forecasting methods
    + Solution should exploit the multivariate nature of the data

### Merit of the chosen path
* Forecasting method believes data come from a generation process and (i) the serial dependency in a time series along with (ii) covariance between time series can account variability in the population

### Assumption
* The main assumption behind the thinking is the given group of time series represents the population of time series so that covariance is reliably estimated

### Let's do some EDA to check feasibility


## EDA: Reservation to Visit (1)

```{r, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
library(wesanderson)
load("~/Coles/weeklyRipper/analysis.RData")
```

```{r, echo = FALSE, fig.align='center', fig.height=3.5}
hpgNairReservationLSmemory
```

* AIR guests prefer to book on the same day or towards weekends
* HPG guests prefer to book towards weekends or on the same day

But do they reserve and visit within the same week?

## EDA: Reservation to Visit (1_circular data)

```{r, echo = FALSE, fig.align='center'}
hpgNairReservationLSmemoryPC
```

Better visualization for examining the pattern

## EDA: Reservation to Visit (2)

```{r, echo = FALSE, fig.align='center', warning=FALSE, message=FALSE}
res2VisitTimeDistPlot
```

* Approximately 55% guests visit within a week of reservation
* Approximately 85% of the guests visit within 3 weeks of reservation

## EDA: Total visitors and reservations (1)

```{r, echo = FALSE, fig.align='center', warning=FALSE, message=FALSE, fig.height=3.5}
aggrAirAllStoresTP
```

* Apparent structural break (systematic missing) in the total number of visitors
* Clear weekly pattern in daily total visitors
* Reservation data is missing from 2016-07-25 -- 2016-10-27
* Difficult to observe relation between visits and reservation

## EDA: Total visitors and reservations (2)

```{r, echo = FALSE, fig.align='center', warning=FALSE, message=FALSE, fig.height=3.5}
aggrAirAllStoresTPLog
```

* Same plot as shown in the previous slide on log scale
* Shows the pattern in the total visit matches with the pattern in reservation
* Reservation declining from end of April to entire May. Is it expected?
* Visit data ends at end of April


## EDA: Total visitors by month

```{r, echo = FALSE, fig.align='center', warning=FALSE, message=FALSE, fig.height=3.5}
smoothAggrAirReserveByMonth
```

* Total visitors declines from March to May (keep in mind the strcutural break!)

## Proposed methodology based on EDA

* Use time series modelling to forecast the total visitors 
* Adjust forecast using reservation data
* Extending the approach
    + Use historical visitation data for each restaurant and obtain unbiased forecast for each of those. These are likely to be less accurate due to low signal to noise
    + Update the noisy forecast at restaurant level by exploiting the aggregation structure and covariance between the series


## Challenges

* Historical reservation data has missing values which makes the exercise challenging
* A weighted combination between forecasting at unit level and at aggregated level can solve this problem but will require substantial effort to complete.
    + Will demonstrate how to adjust forecast for total visitor series using the noisy reservation data only
    + Present results in form of visualization

## Fixing missing in the reservation data

```{r, echo = FALSE, fig.align='center', warning=FALSE, message=FALSE, fig.height=3.5}
rawVsCleanesTSLog
```

* Plots of reservation data fixed for missing values outlier
    + Linear interpolation was used to fill the missing values
    + Structural decomposition was used to reduce the effect of outlines

## Modelling total visit with adjustment

```{r, echo = FALSE, fig.align='center', warning=FALSE, message=FALSE, fig.height=3.5}
ForerawVsCleanesTS
```

* The forecast for the total series was obtained using ARIMA fitting
* Forecasted values (in red) along with 80% forecast interval (in blue) are shown
* Fit of the model is shows using thin red line overlaying the observed data

## Comparions of adusted vs unadjusted forecast

```{r, echo = FALSE, fig.align='center', warning=FALSE, message=FALSE, fig.height=3.5}
foreCompAdjvsNoAdj
```

Which one is better?

* Hard to say without evaluation
* Adjusted model mimics more dynaimc of the observed data
* May be average (/weighted average) of two models is even better

* I beleive EDA supports adjusted method

## Some remarks

* The chosen modeal for adjusted forecasting was ARIMA(5,1,3)(2,0,0)[7]. It shows strong presence of serial dependency (5) + seasonal dependency (2) + dependency in error (3) 
    + The unadjusted forecasting model was ARIMA(1,0,2)(2,1,0)[7]
* This solution has the potential to avoid using engineered features (spatial and temporal feature) of unknown quality and reliability. Specially the spatial features as the locations are not exact.
* A well designed solution for this problem can be  applied to inventory management and can serve multiple layers of decision makers in supply chain management.

## Limitations and future improvement

* Filling the gaps in the reservation data was adhoc. More pedantic approach could be used to address this issue
* Weighted combination to adjust forecast at unit and aggregated level is left as a future exercise follwoing the advocated pathway
* Reservation data for the observed time series is less noisy consider to unobserved part of the total visits. This imply further adjustment requirement and not to use the model for long term forecasting.


